[back](../../20251117定期月總結.md)


有個處理多組織的訊息推播的服務，今天需要修改單一組織推播的訊息內容(改動頻率少)，需要根據一些邏輯動態產生，這些邏輯大概在10個以下，但屬於非常客製化。希望修改單一組織訊息時，不要因此修改程式而重新啟動程式，如果你是工程師，你會怎麼設計這個服務?


## 動態編譯

- 將訊息生成邏輯寫成小程式（例如 Kotlin 語言）。
- 程式在運行時 **載入並編譯執行這段程式碼**。
    
- 優點：
    - 極度彈性，可以處理任何客製邏輯。
    - 適合邏輯非常複雜且無法用模板表達的情況。
        
- 缺點：
    - 安全性風險高 => 用沙箱
    - 開發/測試難度大 => 強制實作介面
    - 性能可能略低 => 修改少，修改後一次編譯重複使用

```kotlin
import model.po.publics.ResultGroupPO
import model.vo.method.CheckResultMapVO
import service.impl.MethodServiceImpl.MessageBuilderRecord
import model.vo.method.CheckColumnVO
import model.po.publics.MessageBuilderPO
import kotlin.code_region.KtsCodeRegionResultGroupInterface

// -------------------- 常數 --------------------
val total_num: Int = 367
// -------------------- 匿名物件回傳 --------------------
object: KtsCodeRegionResultGroupInterface {
  // -------------------- 基本資訊函式 --------------------
  override fun getName(): String = "taichung_sewer_message"

  override fun getDescription(): String = "依照總數367，計算維修中設備"

  override fun getAlowId(): Long = 30L

  override fun getCodeRegion(): Map<String, String> = mapOf(
    "0" to "臺中市雨水下水道總數:${total_num}站，",
    "1" to "XXX 處因配合機關清淤、下水道探勘、道路整建等工程暫時拆除"
  )

  // -------------------- 核心邏輯函式 --------------------
  override fun generateMessage(
    resultGroupPO: ResultGroupPO,
    checkResultMapVO: CheckResultMapVO,
    builderEle: MessageBuilderRecord,
    checkColumnVO: CheckColumnVO?,
    index: String
  ): String {
    return when(index) {
      "0" -> {
        val msg0: String = "臺中市雨水下水道總數:${total_num}站，"
        msg0
      }
      "1" -> {
        val api_total_num: Int = checkResultMapVO.getTotalNum(resultGroupPO.deviceSourceId)
        val fix_num: Int = total_num - api_total_num
        val msg1: String = "${fix_num} 處因配合機關清淤、下水道探勘、道路整建等工程暫時拆除"
        msg1
      }
      else -> {
        val msgDefault: String = ""
        msgDefault
      }
    }
  }
}
```

## 表達式語言

- 將訊息模板裡的動態邏輯表達成簡單的公式/表達式，例如：
    `{{user_points > 100 ? "尊貴會員" : "一般會員"}}`
- 優點：
    - 安全性比動態編譯高（可以限制 API）。
    - 易於修改和維護。
    - 不需要重啟服務即可修改表達式。
- 缺點：
    - 只能表達有限邏輯，過於複雜的邏輯會變得難以維護。
    - 需要先設計好 DSL 或選擇現成引擎。

```yaml
properties:
  total_num: 500
scripts:
  getName: "'taichung_sewer_message_test'"
  getDescription: "'依照總數' + properties.total_num + ' 計算維修中設備'"
  getAlowId: "30"
  getCodeRegion_0: "'臺中市雨水下水道總數:' + properties.total_num + '站，'"
  getCodeRegion_1: "'XXX 處因配合機關清淤等工程暫時拆除'" 
  generateMessage_0: "'臺中市雨水下水道總數:' + properties.total_num + '站，'"
  generateMessage_1: |
      api_total = checkResultMapVO.totalNum;
      fix_num = properties.total_num - api_total;
      return fix_num + " 處因配合工程暫時拆除";
```

